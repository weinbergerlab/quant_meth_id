---
title: "Quantitative Methods in Infectious Disease"
subtitle: "Time series examples"
author: "Dan Weinberger"
date: 'November 28, 2021'
runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
require(shiny)
source('./R/WaveletPkg.R')
source('./R/plot.wave2.R')
source('./R/biennial.func.R')
library(dplyr)
set.seed(123)
```

## Examples

Here are some worked examples of what we are covering in class

## Generating harmonic curves

-First create an index variable for time (1,2,3...t) -Then use sine and cosine functions to generate a wave with specified period -12 month harmonic (sine and cosine waves)

```{r harmonics, echo=TRUE}
t<-1:120

sin12<-sin(2*pi*t/12)

cos12<-cos(2*pi*t/12)
```

```{r}
plot(sin12, type='l', col='red')
 points(cos12, type='l', lty=2, col='blue')
```

## Vary the period

```{r period.slider, echo=FALSE}
#library(shiny)
shinyApp(

  ui = fluidPage(
    sliderInput("period", "Period:",
               min=2, max=36, value=12),
    plotOutput("periodPlot")
  ),

  server = function(input, output) {
    output$periodPlot = renderPlot({
      plot(sin12, type='l', col='gray')
      points(sin(2*pi*t/input$period),type='l', col='red', xlab='time' )
      title(paste0('sin(2*pi*t/',input$period,')'))
    },width = "auto", height = "auto")
  }
)
```

## Harmonic Regression

### Generate count data with known periodicity

-   120 months total
-   (10years of data)
-   Has both a 12 and 24 month cycle -Amplitude=1.5

```{r gen_data , echo=TRUE}
n=120

t<-1:n

set.seed(123)

#Generate some  data that has a frequency of 1/10 and 1/20  frequency (period of 10 ,10 )
amp1=0.75
freq1=1/12 # high frequency

amp2=1.5
freq2=1/24 #low frequency

xt1a=amp1*cos(2*3.14159*t*freq1) #component 1
xt1b=amp2*cos(2*3.14159*t*freq2) #component 2

intercept<-0.0

lambda<- exp(intercept+xt1a+xt1b)
```

Mean (lambda) over time

```{r}
plot(lambda, type='l')
```

Assume xt1 has a mean of lambda at time t, with a Poisson distribution

```{r}
set.seed(1234)
xt1=rpois(n,lambda)

```

View the components of the data we generated

```{r plots1, echo=FALSE}
par(mfrow=c(2,2), mar=c(2,2,1,1))
plot(xt1a, bty='l' , main='Component 1', type='l' , ylim=range(c(xt1a,xt1b)))

plot(xt1b, bty='l' , main='Component 2' , type='l', ylim=range(c(xt1a,xt1b)))

plot(xt1a+xt1b, bty='l' , main='log(Component 1 +Component 2)' , type='l', ylim=range(xt1a+xt1b))

plot(t, xt1,type="l", lwd=3, xaxt="n",bty="l",ylab="Cases of Disease", xlab="Month(n)", main="Cases")
```

## Create the needed harmonic variables with 12, 24, and 48 month periods

```{r harm1, echo=TRUE}
t<-1:120
#Create harmonic variables
sin12=sin(2*pi*t/12)
cos12=cos(2*pi*t/12)

sin24=sin(2*pi*t/24)
cos24=cos(2*pi*t/24)

sin48=sin(2*pi*t/48)
cos48=cos(2*pi*t/48)
```

## Fit a simple poisson regression with just 12 month period

```{r harm_reg1}
fit1a <- glm(xt1 ~ sin12+cos12, family='poisson' )
pred1a<- fitted(fit1a)
```

```{r}
#summary(fit1a)
par(mfrow=c(1,1))
plot (t, xt1,bty="l", xaxt="n",yaxt="n",xlab="Time",ylab="Cases of Disease", type="p")
points(t,pred1a, type="l",lty=1,col="blue", lwd=3)
```

## Add in 24 month periodicity

```{r harm_reg2}
fit2a <- glm(xt1 ~ sin12+cos12 +sin24 +cos24, family='poisson' )
pred2a<- fitted(fit2a)
```

```{r}
#summary(fit2a)
par(mfrow=c(1,1))
plot (t, xt1,bty="l", xaxt="n",yaxt="n",xlab="Time",ylab="Cases of Disease", type="p")
points(t,pred2a, type="l",lty=1,col="blue", lwd=3)
```

## Add in 48 month period

```{r harm_reg3}
fit3a <- glm(xt1 ~ sin12+cos12 +sin24 +cos24 +sin48 +cos48, family='poisson' )
pred3a<- fitted(fit3a)
#summary(fit3a)
par(mfrow=c(1,1))
plot (t, xt1,bty="l", xaxt="n",yaxt="n",xlab="Time",ylab="Cases of Disease", type="p")
points(t,pred3a, type="l",lty=1,col="blue", lwd=3)
```

## Determine best model with AIC (smaller=better)

Winner is Model 2 (12 and 24 month period). Models 2 and 3 have similar AIC score (within 2 points), so we prefer the simpler model

```{r aic}
 AIC(fit1a)
 AIC(fit2a)
 AIC(fit3a)
```

## Calculate amplitude of the 12 and 24 month periods and their ratio

First for the 12 month period. 
Amplitude = sqrt(b1^2 + b2^2)
```{r amp}
beta_sin12<-coef(fit2a)['sin12']
beta_cos12<-coef(fit2a)['cos12']

amp12<-sqrt(beta_sin12^2 +beta_cos12^2)

amp12 #True value=0.75
```

Same for the 24 month period
```{r}
beta_sin24<-coef(fit2a)['sin24']
beta_cos24<-coef(fit2a)['cos24']
amp24<-sqrt(beta_sin24^2 +beta_cos24^2)

amp24 #True value=1.5
```

Ratio of 24 to 12 month gives estimate of importance of biennial vs annual cycles

```{r}
ratio12_24<-amp24/amp12
ratio12_24
```

## Fast Fourier Transform

If we don't already know what periods should be present, can we use first use FFT to detect the correct period? Can sqrt or log transform data prior to FFT

```{r fft1, echo=TRUE}
# Do a FFT using the spectrum function 
mspect <- spectrum(sqrt(xt1),  spans=c(2,2), plot=FALSE)
```

This returns estimates of spectral density for each frequency. We will convert to period=1/frequency

```{r}
periodx <- 1/mspect$freq 
specy <- 2*mspect$spec
plot(periodx, specy, xlab="Period (months)",
     ylab="Spectral Density", type="l", bty='l')
```

##FFT slider

```{r fft.slider, echo=FALSE}
n=1000
shinyApp(

  ui = fluidPage(
    sidebarLayout(position = "left",
    sidebarPanel(
    sliderInput("period1", "Period1:",
               min=2, max=48, value=12),
     sliderInput("amplitude1", "Amplitude1:",
               min=0.2, max=2.5, value=0.75),
    sliderInput("period2", "Period2:",
               min=2, max=48, value=24),
      sliderInput("amplitude2", "Amplitude2:",
               min=0.2, max=2.5, value=1.5),
      sliderInput("int1", "Intercept:",
               min=0, max=5, value=0)
      ),
    mainPanel(
       plotOutput("periodPlot")
    )
  )
  ),

  server = function(input, output) {
    t=1:120
    xt1a=reactive({input$amplitude1*cos(2*3.14159*t/input$period1)}) #component 1
    xt1b=reactive({input$amplitude2*cos(2*3.14159*t/input$period2)}) #component 2
    intercept<-reactive({input$int1})
    lambda<- reactive ({exp(intercept()+xt1a()+xt1b())})
    xt.slide=reactive ({rpois(length(t),lambda())})
    fft.s=reactive ({spectrum(sqrt(xt.slide()), spans=c(2,2), plot=FALSE)})

    output$periodPlot = renderPlot({
      par(mfrow=c(2,1), mar=c(3,2,1,1))
   plot(t, xt.slide(),type="l", lwd=3, bty="l",ylab="Cases of Disease", xlab="Month(n)", main="Cases")

      periodx <- 1/fft.s()$freq 
      specy <- 2*fft.s()$spec
plot(periodx, specy, xlab="Period (months)",
     ylab="Spectral Density", type="l", bty='l')
      

    },width = "auto", height = "auto")
  })
```

## Wavelets

### RSV data from WHO surveillance. Compare Sweden and France

```{r}
#code Courtesy of DeusThindwa; data from WHO
#library(curl)
#library(dplyr)
library(ggplot2)
#rsv <- read.csv(curl("https://frontdoor-l4uikgap6gz3m.azurefd.net/FLUMART/VIW_FNT?$format=csv"))
#saveRDS(rsv,'./Data/rsv_who.rds')

rsv <- readRDS('./Data/rsv_who.rds')

#Clean the data, fill in 0s if not observed
rsvds <-
  rsv %>%
  dplyr::filter(!is.na(RSV)) %>%
  dplyr::select(WHOREGION, FLUSEASON, ORIGIN_SOURCE,HEMISPHERE, COUNTRY_AREA_TERRITORY, MMWR_WEEKSTARTDATE, MMWR_YEAR, MMWR_WEEK, RSV) %>%
  arrange(WHOREGION, COUNTRY_AREA_TERRITORY, MMWR_WEEKSTARTDATE,ORIGIN_SOURCE) %>%
  filter(COUNTRY_AREA_TERRITORY %in% c('France', 'Sweden')) %>%
  mutate(date=as.Date(MMWR_WEEKSTARTDATE)) %>%
  filter(date>='2015-01-01' & date <= '2023-03-01') %>%
  rename(country=COUNTRY_AREA_TERRITORY) %>%
  tidyr::complete(country,ORIGIN_SOURCE,date = seq.Date(from=as.Date('2015-01-04') ,to=as.Date('2022-11-06'), by='week'), fill=list(RSV=0)) %>%
  arrange(country,ORIGIN_SOURCE, date ) %>%
  group_by(country, ORIGIN_SOURCE) %>%
  mutate(t= row_number()) %>%
  ungroup()

rsvds %>% filter(ORIGIN_SOURCE=='NONSENTINEL') %>%
  ggplot( aes(x=date, y=RSV, group=country ,color=country)) +
  geom_line() +
  theme_classic()
```



##Run wavelets on the sqrt(series) we generated

Note: these Wavelet functions originally developed by Johannson et al PLOS Medicine <https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.1000168>

```{r wave2, echo=TRUE}
wave1<- rsvds %>% 
    filter(country=='Sweden' & ORIGIN_SOURCE=='NONSENTINEL' ) %>% 
    mutate(x=sqrt(RSV)) %>%
  select(x, t)
  
cwt1 <- complete.cwt(wave1, dj=1/26, dt=1/52)

plot.cwt(cwt1)

plot.wave2(cwt1 )

```
	
	
```{r}
	wave2<- rsvds %>% 
    filter(country=='France' & ORIGIN_SOURCE=='NONSENTINEL' ) %>% 
    mutate(x=sqrt(RSV)) %>%
  select(x, t)	

cwt2 <- complete.cwt(wave2, dj=1/26, dt=1/52)

plot.cwt(cwt2)
plot.wave2(cwt3 )

```


##Compare phase angle of the 2 series we generated

For the 52 week harmonic
```{r wave3, echo=FALSE}

	phase1<-phase(cwt1, s=c(0.8, 1.2))
	phase2<-phase(cwt2, s=c(0.8, 1.2))
	
	dates <- unique(rsvds$date)
	plot(dates, phase1,type='l', col="blue", lty=1) #Sweden
	points(dates, phase2,type='l', col="red", lty=1) #France
```

##Calculate and view the phase difference

```{r wave4, echo=TRUE}
#Take modulo (%%) of phase difference to account for edge effects as described by Grenfell. This corrects for problems at start and begining of cycles
	phase.diff2.1= phase2-phase1

	phasediff2.1_correct <- ((phase.diff2.1 + 3*pi) %% (2*pi)) - (pi)
	#shows corrected phase diff in modulo for the 12 month phase

	plot(dates,phasediff2.1_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi))

```

##Convert phase difference to weeks

```{r wave5, echo=FALSE}
	phase.diff.wk <- phasediff2.1_correct * 52.143/(2*pi)
	plot(dates,phase.diff.wk,type='l',col="blue", lty=1,ylim=c(-52,52))
```

##Reconstruct series, filtering out noise

```{r wave.recon, echo=FALSE}
 recon1 <- reconstruct.series(cwt1)  #square to get back to original scale
 recon1a <- reconstruct.series(cwt1, sp1=0.8, sp2=1.2)^2 
 recon1b <- reconstruct.series(cwt1, sp1=0.8, sp2=1.2)^2 
 
 plot(dates,recon1,type='l',col="blue", lty=1)
 points(dates,recon1a,type="l",col="red",lty=1)
 points(dates,recon1b,type="l",col="green",lty=1)
```

## Compare biennial vs annual strength in the 2 series

Confirms that biennial pattern is stronger in Sweden than France

```{r annual.biennial}

series1.biennial.ratio <- biennial.func(ds=cwt1,period.range.short=c(0.8,1.2),period.range.long=c(1.8,2.2))

series2.biennial.ratio <- biennial.func(ds=cwt2,period.range.short=c(0.8,1.2),period.range.long=c(1.8,2.2))

series1.biennial.ratio # Sweden

series2.biennial.ratio # France
```

## Coherence analysis Evaluate coherence between the 2 series. At which periodicity do we have correlation?

periods and which time points are the series in sync?

```{r coherence}
#Coherence analysis
coh1.2 <- complete.coh(wave1,wave2, mc.sim=100, dj=1/26, dt=1/52)
plot.coh(coh1.2)
```
